<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coletor Linear Sistemas</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de coleta de produtos com scanner de c√≥digo de barras">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Coletor">
    
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .app {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .content {
            padding: 20px;
        }
        
        .group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        textarea {
            font-family: monospace;
            min-height: 120px;
            resize: vertical;
        }
        
        input:focus, textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .btn-small {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
            display: inline-block;
        }
        
        .btn-blue {
            background: #007bff;
            color: white;
        }
        
        .btn-green {
            background: #28a745;
            color: white;
        }
        
        .btn-red {
            background: #dc3545;
            color: white;
        }
        
        .btn-orange {
            background: #fd7e14;
            color: white;
        }
        
        .btn-purple {
            background: #6f42c1;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .camera {
            width: 100%;
            height: 250px;
            background: #f8f9fa;
            border: 2px dashed #007bff;
            border-radius: 6px;
            display: none;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }
        
        .camera video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 100px;
            border: 3px solid #00ff00;
            border-radius: 8px;
            background: rgba(0, 255, 0, 0.05);
            pointer-events: none;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3),
                        inset 0 0 20px rgba(0, 255, 0, 0.1);
        }
        
        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            box-shadow: 0 0 10px #00ff00;
            animation: scan 1.5s ease-in-out infinite;
        }
        
        @keyframes scan {
            0%, 100% { top: 0; opacity: 1; }
            50% { top: 94px; opacity: 0.5; }
        }
        
        .lista {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 15px;
        }
        
        .item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            font-size: 14px;
            position: relative;
        }
        
        .item-actions {
            margin-top: 8px;
            text-align: right;
        }
        
        .produto-info {
            color: #28a745;
            font-weight: bold;
            margin-top: 4px;
        }
        
        .contador {
            text-align: center;
            background: #e9ecef;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .msg {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        .msg.sucesso {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .msg.erro {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .arquivo-config {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .arquivo-config input {
            flex: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-buttons button {
            flex: 1;
        }
        
        .info-box {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            border-left: 4px solid #0c5460;
        }
        
        .scanner-tip {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üì± Coletor Linear</h1>
            <p>Sistema para Linear Sistemas</p>
        </div>
        
        <div class="content">
            <div class="info-box" id="produtosInfo" style="display:none;">
                üì¶ <span id="totalProdutos">0</span> produtos carregados na base<br>
                <small>üí° Dica: Pode digitar c√≥digos sem zeros √† esquerda (ex: 62 em vez de 0000000000062)</small>
            </div>
            
            <div class="group">
                <label>üì• Importar Base de Produtos (Excel):</label>
                <input type="file" id="arquivoExcel" accept=".xlsx,.xls" onchange="importarProdutos()" style="margin-bottom: 10px;">
                <button class="btn btn-purple" onclick="limparBaseProdutos()" style="margin-bottom: 15px;">
                    üóëÔ∏è Limpar Base de Produtos
                </button>
            </div>
            
            <div class="group">
                <button id="btnCamera" class="btn btn-blue" onclick="toggleScanner()">
                    üì∑ Iniciar Scanner
                </button>
                <div id="camera" class="camera">
                    <video id="video" autoplay playsinline></video>
                    <div class="scanner-overlay">
                        <div class="scanner-line"></div>
                    </div>
                    <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                        üéØ Posicione o c√≥digo na √°rea verde
                    </div>
                    <div class="scanner-tip">
                        üí° Mantenha a dist√¢ncia de 10-15cm do c√≥digo
                    </div>
                </div>
            </div>
            
            <div class="group">
                <label for="codigo">C√≥digo de Barras:</label>
                <input type="text" id="codigo" placeholder="Digite ou escaneie o c√≥digo (ex: 62 ou 0000000000062)">
                <div id="produtoEncontrado" class="produto-info" style="display:none;"></div>
            </div>
            
            <div class="group">
                <label for="quantidade">Quantidade:</label>
                <input type="number" id="quantidade" value="1" step="0.001" placeholder="Ex: 1, 2.5, 10.75">
            </div>
            
            <button class="btn btn-green" onclick="adicionar()">
                ‚ûï Adicionar Item
            </button>
            
            <div id="mensagem" class="msg"></div>
            
            <div class="contador">
                Total: <span id="total">0</span> itens
            </div>
            
            <div id="itens" class="lista">
                <p style="text-align: center; color: #666;">Nenhum item ainda</p>
            </div>
            
            <div class="group">
                <label for="nomeArquivo">Nome do arquivo:</label>
                <input type="text" id="nomeArquivo" placeholder="Ex: inventario, coleta_loja1" value="">
            </div>
            
            <button id="btnBaixarTxt" class="btn btn-blue" onclick="baixarTxt()" disabled>
                üì§ Compartilhar TXT
            </button>
            
            <button id="btnBaixarExcel" class="btn btn-green" onclick="baixarExcel()" disabled>
                üìä Baixar Excel
            </button>
            
            <button class="btn btn-red" onclick="limpar()">
                üóëÔ∏è Limpar Tudo
            </button>
        </div>
    </div>

    <div id="modalEdicao" class="modal">
        <div class="modal-content">
            <h3>üìù Editar Item</h3>
            <div class="group">
                <label for="editQuantidade">Nova quantidade:</label>
                <input type="number" id="editQuantidade" step="0.001" placeholder="Digite a nova quantidade">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-green" onclick="salvarEdicao()">‚úÖ Salvar</button>
                <button class="btn btn-red" onclick="fecharModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalCompartilhar" class="modal">
        <div class="modal-content">
            <h3>üì§ Compartilhar Arquivo</h3>
            <p style="margin-bottom: 15px; color: #666; font-size: 14px;">Escolha como deseja enviar o arquivo:</p>
            <button class="btn btn-green" onclick="compartilharWhatsApp()" style="margin-bottom: 8px;">
                üí¨ Enviar por WhatsApp
            </button>
            <button class="btn btn-blue" onclick="compartilharEmail()" style="margin-bottom: 8px;">
                ‚úâÔ∏è Enviar por E-mail
            </button>
            <button class="btn btn-red" onclick="fecharModalCompartilhar()">
                ‚ùå Cancelar
            </button>
        </div>
    </div>

    <script>
        let dados = [];
        let scannerAtivo = false;
        let codeReader = null;
        let itemEditando = -1;
        let ultimaLeitura = '';
        let tempoUltimaLeitura = 0;
        let stream = null;
        let arquivoGerado = null; // Para armazenar o arquivo TXT gerado
        
        // Base de produtos
        let baseProdutos = {};
        
        // Fun√ß√£o para carregar a base de produtos do localStorage
        function carregarBaseProdutos() {
            const baseSalva = localStorage.getItem('baseProdutos');
            
            if (baseSalva) {
                try {
                    baseProdutos = JSON.parse(baseSalva);
                    const contador = Object.keys(baseProdutos).filter(k => baseProdutos[k].codigoOriginal).length;
                    document.getElementById('totalProdutos').textContent = contador;
                    document.getElementById('produtosInfo').style.display = 'block';
                    console.log('Base de produtos carregada do localStorage:', contador, 'produtos');
                } catch (e) {
                    console.error('Erro ao carregar base de produtos:', e);
                    baseProdutos = {};
                }
            } else {
                console.log('Nenhuma base de produtos encontrada. Importe um arquivo Excel.');
            }
        }
        
        // Fun√ß√£o para salvar base de produtos no localStorage
        function salvarBaseProdutos() {
            try {
                localStorage.setItem('baseProdutos', JSON.stringify(baseProdutos));
                console.log('Base de produtos salva com sucesso!');
            } catch (e) {
                console.error('Erro ao salvar base de produtos:', e);
                alert('Erro ao salvar base de produtos. O arquivo pode ser muito grande.');
            }
        }
        
        // Fun√ß√£o para importar produtos do Excel
        async function importarProdutos() {
            const arquivo = document.getElementById('arquivoExcel').files[0];
            
            if (!arquivo) {
                mostrarMensagem('Selecione um arquivo Excel!', 'erro');
                return;
            }
            
            try {
                const dados = await arquivo.arrayBuffer();
                const workbook = XLSX.read(dados, { type: 'array' });
                const primeiraAba = workbook.Sheets[workbook.SheetNames[0]];
                const linhas = XLSX.utils.sheet_to_json(primeiraAba, { header: 1 });
                
                // Limpar base atual
                baseProdutos = {};
                let contador = 0;
                let erros = 0;
                
                // Processar cada linha (pulando o cabe√ßalho se houver)
                linhas.forEach((linha, index) => {
                    // Pular linhas vazias
                    if (!linha || linha.length === 0) return;
                    
                    // Tentar identificar se √© cabe√ßalho
                    if (index === 0) {
                        const primeiraColuna = String(linha[0]).toLowerCase();
                        if (primeiraColuna.includes('c√≥d') || primeiraColuna.includes('codigo')) {
                            return; // Pular linha de cabe√ßalho
                        }
                    }
                    
                    const codigoBarras = String(linha[0] || '').trim();
                    const descricao = String(linha[1] || '').trim();
                    const um = String(linha[2] || 'UN').trim();
                    
                    if (codigoBarras && descricao) {
                        const produtoInfo = {
                            descricao: descricao,
                            um: um,
                            codigoOriginal: codigoBarras
                        };
                        
                        // Indexar com o c√≥digo completo
                        baseProdutos[codigoBarras] = produtoInfo;
                        
                        // Indexar tamb√©m sem os zeros √† esquerda (se come√ßar com zeros)
                        if (codigoBarras.startsWith('0')) {
                            const codigoSemZeros = codigoBarras.replace(/^0+/, '');
                            if (codigoSemZeros && codigoSemZeros !== codigoBarras) {
                                baseProdutos[codigoSemZeros] = produtoInfo;
                            }
                        }
                        
                        contador++;
                    } else {
                        erros++;
                    }
                });
                
                // Salvar no localStorage
                salvarBaseProdutos();
                
                // Atualizar interface
                document.getElementById('totalProdutos').textContent = contador;
                document.getElementById('produtosInfo').style.display = 'block';
                
                let mensagem = `‚úÖ ${contador} produtos importados com sucesso!`;
                if (erros > 0) {
                    mensagem += ` (${erros} linhas com erro foram ignoradas)`;
                }
                
                mostrarMensagem(mensagem, 'sucesso');
                
                // Limpar input
                document.getElementById('arquivoExcel').value = '';
                
            } catch (e) {
                console.error('Erro ao importar produtos:', e);
                mostrarMensagem('Erro ao processar arquivo Excel: ' + e.message, 'erro');
            }
        }
        
        // Fun√ß√£o para limpar base de produtos
        function limparBaseProdutos() {
            if (Object.keys(baseProdutos).length === 0) {
                mostrarMensagem('N√£o h√° produtos na base!', 'erro');
                return;
            }
            
            if (confirm('Deseja realmente limpar toda a base de produtos? Esta a√ß√£o n√£o pode ser desfeita.')) {
                baseProdutos = {};
                localStorage.removeItem('baseProdutos');
                document.getElementById('totalProdutos').textContent = '0';
                document.getElementById('produtosInfo').style.display = 'none';
                document.getElementById('produtoEncontrado').style.display = 'none';
                mostrarMensagem('Base de produtos limpa!', 'sucesso');
            }
        }
        
        // Fun√ß√£o para buscar produto na base
        function buscarProduto(codigo) {
            const divProduto = document.getElementById('produtoEncontrado');
            let produto = null;
            
            // Tentar buscar com o c√≥digo exato
            produto = baseProdutos[codigo];
            
            // Se n√£o encontrou, tentar adicionar zeros √† esquerda (at√© 13 d√≠gitos - padr√£o EAN-13)
            if (!produto && /^\d+$/.test(codigo)) {
                for (let tamanho = codigo.length + 1; tamanho <= 13; tamanho++) {
                    const codigoComZeros = codigo.padStart(tamanho, '0');
                    produto = baseProdutos[codigoComZeros];
                    if (produto) {
                        console.log(`Produto encontrado com zeros: ${codigoComZeros}`);
                        break;
                    }
                }
            }
            
            // Se n√£o encontrou, tentar remover zeros √† esquerda
            if (!produto && codigo.startsWith('0')) {
                const codigoSemZeros = codigo.replace(/^0+/, '');
                produto = baseProdutos[codigoSemZeros];
                if (produto) {
                    console.log(`Produto encontrado sem zeros: ${codigoSemZeros}`);
                }
            }
            
            if (produto) {
                divProduto.textContent = `‚úÖ ${produto.descricao} (${produto.um})`;
                divProduto.style.display = 'block';
                divProduto.style.color = '#28a745';
                return produto;
            } else {
                divProduto.textContent = '‚ö†Ô∏è Produto n√£o encontrado na base';
                divProduto.style.display = 'block';
                divProduto.style.color = '#fd7e14';
                return null;
            }
        }
        
        // Event listener para buscar produto ao digitar c√≥digo
        document.getElementById('codigo').addEventListener('input', function(e) {
            const codigo = e.target.value.trim();
            if (codigo.length >= 3) {
                buscarProduto(codigo);
            } else {
                document.getElementById('produtoEncontrado').style.display = 'none';
            }
        });
        
        // Fun√ß√£o para toggle do scanner OTIMIZADO
        async function toggleScanner() {
            const camera = document.getElementById('camera');
            const video = document.getElementById('video');
            const btnCamera = document.getElementById('btnCamera');
            
            if (!scannerAtivo) {
                try {
                    camera.style.display = 'block';
                    btnCamera.textContent = '‚è∏Ô∏è Parar Scanner';
                    btnCamera.classList.remove('btn-blue');
                    btnCamera.classList.add('btn-red');
                    
                    // Configura√ß√µes otimizadas para a c√¢mera
                    const constraints = {
                        video: {
                            facingMode: 'environment', // C√¢mera traseira
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            focusMode: { ideal: 'continuous' },
                            zoom: { ideal: 1.0 }
                        }
                    };
                    
                    // Obter stream de v√≠deo
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    
                    // Aplicar configura√ß√µes avan√ßadas se dispon√≠veis
                    const track = stream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();
                    const settings = {};
                    
                    if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                        settings.focusMode = 'continuous';
                    }
                    if (capabilities.torch) {
                        // Podemos adicionar controle de lanterna se necess√°rio
                    }
                    
                    if (Object.keys(settings).length > 0) {
                        await track.applyConstraints({ advanced: [settings] });
                    }
                    
                    // Criar leitor com configura√ß√µes otimizadas
                    const hints = new Map();
                    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                        ZXing.BarcodeFormat.EAN_13,
                        ZXing.BarcodeFormat.EAN_8,
                        ZXing.BarcodeFormat.CODE_128,
                        ZXing.BarcodeFormat.CODE_39,
                        ZXing.BarcodeFormat.UPC_A,
                        ZXing.BarcodeFormat.UPC_E
                    ]);
                    
                    codeReader = new ZXing.BrowserMultiFormatReader(hints);
                    
                    // Iniciar decodifica√ß√£o com callback otimizado
                    codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
                        if (result) {
                            const codigo = result.text;
                            const agora = Date.now();
                            
                            // Evitar leituras duplicadas em menos de 1.5 segundos
                            if (codigo === ultimaLeitura && (agora - tempoUltimaLeitura) < 1500) {
                                return;
                            }
                            
                            ultimaLeitura = codigo;
                            tempoUltimaLeitura = agora;
                            
                            // Processar c√≥digo
                            document.getElementById('codigo').value = codigo;
                            buscarProduto(codigo);
                            
                            // Feedback visual
                            camera.style.borderColor = '#28a745';
                            setTimeout(() => {
                                camera.style.borderColor = '#007bff';
                            }, 300);
                            
                            // Tocar som de bip mais agrad√°vel
                            const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGmm98OScTgwOUKXh8bllHgU2jdXzzn0vBSh+zPLaizsKFFyw6OyrWBUIQ5zd8sFuJAUuhM/z2Ik2CBlpu+3nnk0MDFCn4fC2Yx0GN5HY88p9LgUle8nx3I4+ChRdsOjrq1gVCEOc3fLBbiQFLoTP89iJNggZabvt555NDA==');
                            beep.volume = 0.3;
                            beep.play().catch(() => {});
                            
                            // Vibrar se dispon√≠vel
                            if (navigator.vibrate) {
                                navigator.vibrate(100);
                            }
                        }
                    });
                    
                    scannerAtivo = true;
                } catch (err) {
                    console.error('Erro ao acessar c√¢mera:', err);
                    alert('Erro ao acessar c√¢mera: ' + err.message + '\n\nDica: Verifique se voc√™ deu permiss√£o para usar a c√¢mera.');
                    camera.style.display = 'none';
                    btnCamera.textContent = 'üì∑ Iniciar Scanner';
                    btnCamera.classList.remove('btn-red');
                    btnCamera.classList.add('btn-blue');
                }
            } else {
                // Parar scanner
                if (codeReader) {
                    codeReader.reset();
                }
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                video.srcObject = null;
                camera.style.display = 'none';
                btnCamera.textContent = 'üì∑ Iniciar Scanner';
                btnCamera.classList.remove('btn-red');
                btnCamera.classList.add('btn-blue');
                scannerAtivo = false;
                ultimaLeitura = '';
            }
        }
        
        // Fun√ß√£o para adicionar item
        function adicionar() {
            const codigo = document.getElementById('codigo').value.trim();
            const quantidade = parseFloat(document.getElementById('quantidade').value);
            
            if (!codigo) {
                mostrarMensagem('Digite um c√≥digo de barras!', 'erro');
                return;
            }
            
            if (!quantidade || quantidade <= 0) {
                mostrarMensagem('Digite uma quantidade v√°lida!', 'erro');
                return;
            }
            
            const produto = baseProdutos[codigo];
            const descricao = produto ? produto.descricao : 'Produto n√£o cadastrado';
            const um = produto ? produto.um : 'UN';
            const codigoFinal = produto ? produto.codigoOriginal : codigo;
            
            dados.push({
                codigo: codigoFinal,
                quantidade: quantidade,
                descricao: descricao,
                um: um,
                timestamp: new Date().toLocaleString()
            });
            
            atualizarLista();
            mostrarMensagem('Item adicionado com sucesso!', 'sucesso');
            
            // Limpar campos
            document.getElementById('codigo').value = '';
            document.getElementById('quantidade').value = '1';
            document.getElementById('produtoEncontrado').style.display = 'none';
            document.getElementById('codigo').focus();
        }
        
        // Fun√ß√£o para atualizar lista
        function atualizarLista() {
            const container = document.getElementById('itens');
            const total = document.getElementById('total');
            const btnBaixarTxt = document.getElementById('btnBaixarTxt');
            const btnBaixarExcel = document.getElementById('btnBaixarExcel');
            
            if (dados.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Nenhum item ainda</p>';
                total.textContent = '0';
                btnBaixarTxt.disabled = true;
                btnBaixarExcel.disabled = true;
                return;
            }
            
            container.innerHTML = '';
            dados.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <strong>${item.codigo}</strong><br>
                    ${item.descricao}<br>
                    Quantidade: <strong>${item.quantidade} ${item.um}</strong><br>
                    <small style="color: #666;">${item.timestamp}</small>
                    <div class="item-actions">
                        <button class="btn btn-small btn-orange" onclick="editarItem(${index})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-small btn-red" onclick="removerItem(${index})">üóëÔ∏è Remover</button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            total.textContent = dados.length;
            btnBaixarTxt.disabled = false;
            btnBaixarExcel.disabled = false;
        }
        
        // Fun√ß√£o para editar item
        function editarItem(index) {
            itemEditando = index;
            document.getElementById('editQuantidade').value = dados[index].quantidade;
            document.getElementById('modalEdicao').style.display = 'block';
        }
        
        // Fun√ß√£o para salvar edi√ß√£o
        function salvarEdicao() {
            const novaQtd = parseFloat(document.getElementById('editQuantidade').value);
            
            if (!novaQtd || novaQtd <= 0) {
                alert('Digite uma quantidade v√°lida!');
                return;
            }
            
            dados[itemEditando].quantidade = novaQtd;
            dados[itemEditando].timestamp = new Date().toLocaleString();
            
            atualizarLista();
            fecharModal();
            mostrarMensagem('Item atualizado com sucesso!', 'sucesso');
        }
        
        // Fun√ß√£o para fechar modal
        function fecharModal() {
            document.getElementById('modalEdicao').style.display = 'none';
            itemEditando = -1;
        }
        
        // Fun√ß√£o para remover item
        function removerItem(index) {
            if (confirm('Deseja realmente remover este item?')) {
                dados.splice(index, 1);
                atualizarLista();
                mostrarMensagem('Item removido!', 'sucesso');
            }
        }
        
        // Fun√ß√£o para preparar e compartilhar arquivo TXT
        function baixarTxt() {
            if (dados.length === 0) {
                mostrarMensagem('N√£o h√° itens para compartilhar!', 'erro');
                return;
            }
            
            let nomeArquivo = document.getElementById('nomeArquivo').value.trim();
            if (!nomeArquivo) {
                nomeArquivo = 'coleta_' + new Date().toISOString().slice(0,10);
            }
            
            // Gerar conte√∫do do arquivo no formato do coletor
            let conteudo = '';
            dados.forEach(item => {
                // C√≥digo de barras: 13 caracteres (preencher com zeros √† esquerda)
                const codigoFormatado = String(item.codigo).padStart(13, '0');
                
                // Quantidade: 8 caracteres (multiplicar por 1000 para 3 casas decimais e preencher com zeros √† esquerda)
                const quantidadeInteira = Math.round(item.quantidade * 1000);
                const quantidadeFormatada = String(quantidadeInteira).padStart(8, '0');
                
                // Formato: CODIGO,QUANTIDADE com quebra de linha Windows (CRLF)
                conteudo += `${codigoFormatado},${quantidadeFormatada}\r\n`;
            });
            
            // Criar arquivo blob
            const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
            
            // Armazenar para compartilhamento
            arquivoGerado = {
                blob: blob,
                nome: nomeArquivo + '.txt',
                conteudo: conteudo
            };
            
            // Mostrar modal de compartilhamento
            document.getElementById('modalCompartilhar').style.display = 'block';
        }
        
        // Fun√ß√£o para fechar modal de compartilhamento
        function fecharModalCompartilhar() {
            document.getElementById('modalCompartilhar').style.display = 'none';
        }
        
        // Fun√ß√£o para compartilhar via WhatsApp
        function compartilharWhatsApp() {
            if (!arquivoGerado) {
                alert('Nenhum arquivo foi gerado ainda!');
                return;
            }
            
            const file = new File([arquivoGerado.blob], arquivoGerado.nome, { type: 'text/plain' });
            
            // Tentar usar Web Share API (funciona melhor no mobile)
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({
                    title: 'Coleta de Produtos',
                    text: `Arquivo de coleta: ${arquivoGerado.nome}\nTotal de itens: ${dados.length}`,
                    files: [file]
                }).then(() => {
                    fecharModalCompartilhar();
                    mostrarMensagem('Arquivo compartilhado com sucesso!', 'sucesso');
                }).catch(err => {
                    if (err.name !== 'AbortError') {
                        console.log('Erro ao compartilhar:', err);
                        // Fallback: baixar arquivo e abrir WhatsApp
                        baixarArquivoManual();
                        abrirWhatsAppComMensagem();
                    }
                });
            } else {
                // Fallback para desktop ou navegadores antigos
                baixarArquivoManual();
                abrirWhatsAppComMensagem();
            }
        }
        
        // Fun√ß√£o auxiliar para baixar arquivo manualmente
        function baixarArquivoManual() {
            const url = window.URL.createObjectURL(arquivoGerado.blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = arquivoGerado.nome;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Fun√ß√£o auxiliar para abrir WhatsApp com mensagem
        function abrirWhatsAppComMensagem() {
            const mensagem = `üì¶ *Coleta de Produtos*\n\nArquivo: ${arquivoGerado.nome}\nTotal de itens: ${dados.length}\n\n_Arquivo TXT foi baixado, anexe-o manualmente_`;
            const mensagemCodificada = encodeURIComponent(mensagem);
            const urlWhatsApp = `https://wa.me/?text=${mensagemCodificada}`;
            window.open(urlWhatsApp, '_blank');
            fecharModalCompartilhar();
            
            alert('üí° O arquivo foi baixado!\n\nPor favor, anexe o arquivo manualmente no WhatsApp.');
        }
        
        // Fun√ß√£o para compartilhar via Email
        function compartilharEmail() {
            if (!arquivoGerado) {
                alert('Nenhum arquivo foi gerado ainda!');
                return;
            }
            
            const file = new File([arquivoGerado.blob], arquivoGerado.nome, { type: 'text/plain' });
            
            // Tentar usar Web Share API primeiro
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({
                    title: `Coleta de Produtos - ${arquivoGerado.nome}`,
                    text: `Segue arquivo de coleta com ${dados.length} itens.`,
                    files: [file]
                }).then(() => {
                    fecharModalCompartilhar();
                    mostrarMensagem('Arquivo compartilhado com sucesso!', 'sucesso');
                }).catch(err => {
                    if (err.name !== 'AbortError') {
                        console.log('Erro ao compartilhar:', err);
                        // Fallback: baixar e abrir email
                        baixarArquivoManual();
                        abrirEmailComMensagem();
                    }
                });
            } else {
                // Fallback: baixar arquivo e abrir cliente de email
                baixarArquivoManual();
                abrirEmailComMensagem();
            }
        }
        
        // Fun√ß√£o auxiliar para abrir email
        function abrirEmailComMensagem() {
            const assunto = encodeURIComponent(`Coleta de Produtos - ${arquivoGerado.nome}`);
            const corpo = encodeURIComponent(`Segue em anexo o arquivo de coleta.\n\nTotal de itens: ${dados.length}\nArquivo: ${arquivoGerado.nome}\n\nO arquivo foi baixado, por favor anexe-o manualmente.`);
            
            window.location.href = `mailto:?subject=${assunto}&body=${corpo}`;
            fecharModalCompartilhar();
            
            alert('üí° O arquivo foi baixado!\n\nPor favor, anexe o arquivo manualmente no email.');
        }
        
        // Fun√ß√£o para baixar arquivo Excel
        function baixarExcel() {
            if (dados.length === 0) {
                mostrarMensagem('N√£o h√° itens para baixar!', 'erro');
                return;
            }
            
            let nomeArquivo = document.getElementById('nomeArquivo').value.trim();
            if (!nomeArquivo) {
                nomeArquivo = 'coleta_' + new Date().toISOString().slice(0,10);
            }
            
            // Preparar dados para o Excel no formato do coletor
            const dadosExcel = dados.map(item => {
                // C√≥digo de barras: 13 caracteres (preencher com zeros √† esquerda)
                const codigoFormatado = String(item.codigo).padStart(13, '0');
                
                // Quantidade: 8 caracteres (multiplicar por 1000 para 3 casas decimais e preencher com zeros √† esquerda)
                const quantidadeInteira = Math.round(item.quantidade * 1000);
                const quantidadeFormatada = String(quantidadeInteira).padStart(8, '0');
                
                return {
                    'C√≥digo de Barras': codigoFormatado,
                    'Quantidade': quantidadeFormatada
                };
            });
            
            // Criar workbook e worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(dadosExcel);
            
            // Ajustar largura das colunas
            const colWidths = [
                { wch: 15 }, // C√≥digo
                { wch: 12 }  // Quantidade
            ];
            ws['!cols'] = colWidths;
            
            // Adicionar worksheet ao workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Coleta');
            
            // Gerar e baixar arquivo
            XLSX.writeFile(wb, nomeArquivo + '.xlsx');
            
            mostrarMensagem('Arquivo Excel baixado com sucesso!', 'sucesso');
        }
        
        // Fun√ß√£o para limpar tudo
        function limpar() {
            if (dados.length === 0) {
                mostrarMensagem('N√£o h√° itens para limpar!', 'erro');
                return;
            }
            
            if (confirm('Deseja realmente limpar todos os itens?')) {
                dados = [];
                atualizarLista();
                mostrarMensagem('Lista limpa!', 'sucesso');
            }
        }
        
        // Fun√ß√£o para mostrar mensagem
        function mostrarMensagem(texto, tipo) {
            const msg = document.getElementById('mensagem');
            msg.textContent = texto;
            msg.className = 'msg ' + tipo;
            msg.style.display = 'block';
            
            setTimeout(() => {
                msg.style.display = 'none';
            }, 3000);
        }
        
        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modalEdicao = document.getElementById('modalEdicao');
            const modalCompartilhar = document.getElementById('modalCompartilhar');
            
            if (event.target === modalEdicao) {
                fecharModal();
            }
            
            if (event.target === modalCompartilhar) {
                fecharModalCompartilhar();
            }
        }
        
        // Permitir adicionar com Enter
        document.getElementById('quantidade').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                adicionar();
            }
        });
        
        document.getElementById('codigo').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('quantidade').focus();
            }
        });
        
        // Carregar base de produtos ao iniciar
        carregarBaseProdutos();
        
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/coletor-linear/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
